image: ubuntu:latest

before_script:
  - echo $fdroid_keystore_base64 | base64 -d >keystore.bks
  - chmod 600 fdroid/config.py keystore.bks
  - mkdir -p fdroid/repo
  - apt-get update && apt-get -y install --no-install-recommends fdroidserver wget

pages:
  stage: deploy
  script:
  - cd fdroid
  - (cd repo && wget -nc --content-disposition "https://download.mozilla.org/?product=fennec-latest&os=android&lang=multi")
  - (cd repo && wget -nc --content-disposition "https://download.mozilla.org/?product=fennec-latest&os=android-x86&lang=multi")
  - (cd repo && wget -nc --content-disposition "https://download.mozilla.org/?product=fennec-beta-latest&os=android&lang=multi")
  - (cd repo && wget -nc --content-disposition "https://download.mozilla.org/?product=fennec-beta-latest&os=android-x86&lang=multi")
  - (cd repo && wget -N "https://download-installer.cdn.mozilla.net/pub/android/focus/latest/Focus-arm.apk")
  - (cd repo && wget -N "https://download-installer.cdn.mozilla.net/pub/android/focus/latest/Focus-x86.apk")
  - (cd repo && wget -N "https://download-installer.cdn.mozilla.net/pub/android/focus/latest/Klar-arm.apk")
  - (cd repo && wget -N "https://download-installer.cdn.mozilla.net/pub/android/focus/latest/Klar-x86.apk")
  - echo "keypass=\"$fdroid_keypass\"" >>config.py
  - echo "keystorepass=\"$fdroid_keystorepass\"" >>config.py
  - fdroid update
  - mkdir /fdroid && fdroid server update
  - rm -rf /fdroid/archive
  - cd .. && mkdir public && mv -v /fdroid public
  artifacts:
    paths:
    - public
  only:
  - master
  - schedules
  cache:
    paths:
    - fdroid
